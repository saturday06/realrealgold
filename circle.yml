machine:
  environment:
    MYSQL_DATABASE: circle_test
    MYSQL_HOST: localhost
    MYSQL_PASSWORD:
    MYSQL_PORT: 3306
    MYSQL_USER: ubuntu

general:
  artifacts:
    - "~/.local/bin"

dependencies:
  cache_directories:
    - "~/.stack"
    - "~/usr"
    - ".stack-work"
  pre:
    - sudo apt-get update; sudo apt-get install libgmp-dev
  override:
    - |
      if [ ! -f ~/usr/include/stdio.h ]; then
        GLIBC=glibc-2.23
        wget http://ftp.gnu.org/gnu/glibc/$GLIBC.tar.xz
        tar xf $GLIBC.tar.xz
        cd $GLIBC
        mkdir build
        cd build
        CFLAGS=-O3 ../configure --prefix=$HOME/usr --enable-static-nss \
          && make \
          && make install
        cd ../..
      fi
      find ~/usr
      export C_INCLUDE_PATH=$HOME/usr/include
      export CPLUS_INCLUDE_PATH=$HOME/usr/include
      export LIBRARY_PATH=$HOME/usr/lib:$HOME/usr/lib64
      ./stackw test --only-dependencies --install-ghc

test:
  override:
    - |
      export C_INCLUDE_PATH=$HOME/include
      export CPLUS_INCLUDE_PATH=$HOME/include
      export LIBRARY_PATH=$HOME/lib:$HOME/lib64
      ./stackw install
      cp config/circleci-settings.yml config/test-settings.yml
      ./stackw test

# deployment:
#   production:
#     branch: master
#     heroku:
#       appname: realrealgold
